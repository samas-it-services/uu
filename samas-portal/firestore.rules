rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ============ HELPER FUNCTIONS ============

    function isAuthenticated() {
      return request.auth != null;
    }

    function userDocExists() {
      return exists(/databases/$(database)/documents/users/$(request.auth.uid));
    }

    function getUserData() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data;
    }

    function getRole() {
      return getUserData().role;
    }

    function isSuperuser() {
      return isAuthenticated() && userDocExists() && getRole() == 'superuser';
    }

    function isProjectManager() {
      return isAuthenticated() && userDocExists() && getRole() == 'project_manager';
    }

    function isQAManager() {
      return isAuthenticated() && userDocExists() && getRole() == 'qa_manager';
    }

    function isFinanceIncharge() {
      return isAuthenticated() && userDocExists() && getRole() == 'finance_incharge';
    }

    function isAnalyst() {
      return isAuthenticated() && userDocExists() && getRole() == 'analyst';
    }

    function isProjectMember(projectId) {
      return isAuthenticated() && userDocExists() && projectId in getUserData().projects;
    }

    function isOwner(resourceOwnerId) {
      return request.auth.uid == resourceOwnerId;
    }

    // ============ USERS ============

    match /users/{userId} {
      // Anyone authenticated can read user profiles (for display)
      allow read: if isAuthenticated();

      // Users can create their own document on first sign-in
      allow create: if isAuthenticated() && request.auth.uid == userId;

      // Users can update their own non-sensitive fields; superuser can update all
      allow update: if isSuperuser() ||
                       (request.auth.uid == userId &&
                        !request.resource.data.diff(resource.data).affectedKeys()
                          .hasAny(['role', 'projects', 'isActive']));

      // Only superuser can delete users
      allow delete: if isSuperuser();
    }

    // ============ ROLES (RBAC) ============

    match /roles/{roleId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isSuperuser();
    }

    // ============ PROJECTS ============

    match /projects/{projectId} {
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        isFinanceIncharge() ||
        isProjectMember(projectId)
      );

      allow create: if isSuperuser();

      allow update: if isSuperuser() || (
        isProjectManager() && isProjectMember(projectId)
      );

      allow delete: if isSuperuser();

      // Sensitive data subcollection - restricted
      match /sensitiveData/{docId} {
        allow read, write: if isSuperuser() || isFinanceIncharge();
      }

      // Project activities subcollection
      match /activities/{activityId} {
        allow read: if isSuperuser() || isProjectMember(projectId);
        allow create: if isAuthenticated() && isProjectMember(projectId);
        allow update, delete: if false; // Immutable
      }
    }

    // ============ TASKS ============

    match /tasks/{taskId} {
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        isProjectMember(resource.data.projectId)
      );

      allow create: if isSuperuser() || (
        isProjectManager() && isProjectMember(request.resource.data.projectId)
      );

      allow update: if isSuperuser() || (
        isProjectManager() && isProjectMember(resource.data.projectId)
      ) || (
        (isQAManager() || isAnalyst() || isFinanceIncharge()) &&
        isProjectMember(resource.data.projectId) &&
        isOwner(resource.data.assignedTo)
      );

      allow delete: if isSuperuser() || (
        isProjectManager() && isProjectMember(resource.data.projectId)
      );

      // Task comments subcollection
      match /comments/{commentId} {
        allow read: if isAuthenticated() && (
          isSuperuser() ||
          isProjectMember(get(/databases/$(database)/documents/tasks/$(taskId)).data.projectId)
        );
        allow create: if isAuthenticated() &&
          isProjectMember(get(/databases/$(database)/documents/tasks/$(taskId)).data.projectId);
        allow update: if isOwner(resource.data.userId);
        allow delete: if isSuperuser() || isOwner(resource.data.userId);
      }
    }

    // ============ ANNOUNCEMENTS ============

    match /announcements/{announcementId} {
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        resource.data.targetType == 'all' ||
        (resource.data.projectId != null && isProjectMember(resource.data.projectId))
      );

      allow create: if isSuperuser() || (
        (isProjectManager() || isQAManager() || isFinanceIncharge()) &&
        isProjectMember(request.resource.data.projectId)
      );

      allow update: if isSuperuser() || (
        (isProjectManager() || isQAManager() || isFinanceIncharge()) &&
        isProjectMember(resource.data.projectId)
      ) || (
        // Allow marking as read
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['readBy', 'readCount'])
      );

      allow delete: if isSuperuser() || (
        isProjectManager() && isProjectMember(resource.data.projectId)
      );
    }

    // ============ FINANCE ============

    match /finance/{financeId} {
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        isFinanceIncharge() ||
        ((isProjectManager() || isQAManager()) && isProjectMember(resource.data.projectId))
      );

      allow create, update, delete: if isSuperuser() || isFinanceIncharge();
    }

    // Expenses collection (alternative finance structure)
    match /expenses/{expenseId} {
      allow read: if isAuthenticated() && (
        isSuperuser() ||
        isFinanceIncharge() ||
        isOwner(resource.data.userId) ||
        (resource.data.projectId != null && isProjectManager() && isProjectMember(resource.data.projectId))
      );

      // Anyone can create their own expense
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid;

      // Finance can update any, users can update own draft
      allow update: if isSuperuser() ||
                       isFinanceIncharge() ||
                       (isOwner(resource.data.userId) &&
                        resource.data.status in ['draft', 'needs_info']);

      allow delete: if isSuperuser() || isFinanceIncharge();
    }

    // ============ DOCUMENTS ============

    match /documents/{documentId} {
      function canAccessByVisibility() {
        let doc = resource.data;
        return doc.visibility == 'global' ||
          (doc.visibility == 'private' && isOwner(doc.createdBy)) ||
          (doc.visibility == 'project' && isProjectMember(doc.projectId)) ||
          (doc.visibility == 'role' && getRole() in doc.allowedRoles);
      }

      allow read: if isAuthenticated() && (
        isSuperuser() || canAccessByVisibility()
      );

      allow create: if isAuthenticated() && (
        isSuperuser() ||
        isProjectManager() ||
        ((isQAManager() || isFinanceIncharge() || isAnalyst()) &&
         request.resource.data.createdBy == request.auth.uid)
      );

      allow update: if isAuthenticated() && (
        isSuperuser() ||
        (isProjectManager() && isProjectMember(resource.data.projectId)) ||
        ((isQAManager() || isFinanceIncharge()) && canAccessByVisibility()) ||
        (isAnalyst() && isOwner(resource.data.createdBy))
      );

      allow delete: if isSuperuser() ||
        (isProjectManager() && isProjectMember(resource.data.projectId)) ||
        (isAnalyst() && isOwner(resource.data.createdBy));
    }

    // ============ ASSETS ============

    match /assets/{assetId} {
      function canAccessByVisibility() {
        let asset = resource.data;
        return asset.visibility == 'global' ||
          (asset.visibility == 'private' && isOwner(asset.createdBy)) ||
          (asset.visibility == 'project' && isProjectMember(asset.projectId)) ||
          (asset.visibility == 'role' && getRole() in asset.allowedRoles);
      }

      allow read: if isAuthenticated() && (
        isSuperuser() ||
        isFinanceIncharge() ||
        canAccessByVisibility() ||
        isOwner(resource.data.assignedTo)
      );

      allow create: if isSuperuser() || isProjectManager();

      allow update: if isAuthenticated() && (
        isSuperuser() ||
        (isProjectManager() && isProjectMember(resource.data.projectId)) ||
        ((isQAManager() || isFinanceIncharge() || isAnalyst()) && canAccessByVisibility())
      );

      allow delete: if isSuperuser() ||
        (isProjectManager() && isProjectMember(resource.data.projectId));
    }

    // ============ PRESENCE ============

    match /presence/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == userId;
    }

    // ============ AUDIT LOGS ============

    match /auditLogs/{logId} {
      allow read: if isSuperuser();
      allow create: if isAuthenticated();
      allow update, delete: if false; // Immutable
    }

    // ============ CUSTOM FIELD DEFINITIONS ============

    match /customFieldDefinitions/{fieldId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isSuperuser() || (
        isProjectManager() &&
        request.resource.data.projectId != null &&
        isProjectMember(request.resource.data.projectId)
      );
    }
  }
}
